<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å›½é«˜é“ç½‘ç»œè§„åˆ’ä¸åˆ†æç³»ç»Ÿ</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Microsoft YaHei', sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        .sidebar {
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        #main-map {
            height: 100vh;
            width: 100%;
        }
        .card-custom {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        .card-custom:hover {
            transform: translateY(-2px);
        }
        .result-card {
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hub-bar {
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
            margin-top: 5px;
            overflow: hidden;
        }
        .hub-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffc107, #fd7e14);
            width: 0;
            transition: width 1s ease-out;
        }
        .badge-time { background-color: #dc3545; }
        .badge-cost { background-color: #198754; }
        
        /* Loading overlay */
        #loading {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
    </style>
</head>
<body>

<!-- Loading Screen -->
<div id="loading">
    <div class="spinner-border text-primary mb-3" role="status"></div>
    <h5 class="text-muted">æ­£åœ¨åŠ è½½é«˜é“ç½‘ç»œæ•°æ®...</h5>
</div>

<div class="container-fluid p-0">
    <div class="row g-0">
        <!-- Sidebar -->
        <div class="col-md-3 sidebar">
            <div class="d-flex align-items-center mb-4">
                <i class="fas fa-subway fa-2x text-primary me-3"></i>
                <div>
                    <h5 class="mb-0 fw-bold">ä¸­å›½é«˜é“ç½‘ç»œ</h5>
                    <small class="text-muted">è§„åˆ’ä¸åˆ†æç³»ç»Ÿ</small>
                </div>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-pills mb-4 nav-fill" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pills-route-tab" data-bs-toggle="pill" data-bs-target="#pills-route" type="button">
                        <i class="fas fa-route me-1"></i>è·¯å¾„è§„åˆ’
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-analysis-tab" data-bs-toggle="pill" data-bs-target="#pills-analysis" type="button">
                        <i class="fas fa-chart-bar me-1"></i>æ¢çº½åˆ†æ
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-mst-tab" data-bs-toggle="pill" data-bs-target="#pills-mst" type="button">
                        <i class="fas fa-project-diagram me-1"></i>æœ€å°ç”Ÿæˆæ ‘
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                <!-- Route Planning Tab -->
                <div class="tab-pane fade show active" id="pills-route">
                    <div class="card card-custom bg-light">
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label small text-muted">èµ·ç‚¹åŸå¸‚</label>
                                <select class="form-select" id="startCity">
                                    <option selected disabled>é€‰æ‹©èµ·ç‚¹...</option>
                                </select>
                            </div>
                            
                            <!-- Waypoints Section -->
                            <div id="waypointsContainer"></div>
                            <button class="btn btn-outline-secondary btn-sm w-100 mb-3 dashed-border" onclick="addWaypoint()">
                                <i class="fas fa-plus me-1"></i>æ·»åŠ é€”å¾„åŸå¸‚
                            </button>

                            <div class="mb-3">
                                <label class="form-label small text-muted">ç»ˆç‚¹åŸå¸‚</label>
                                <select class="form-select" id="endCity">
                                    <option selected disabled>é€‰æ‹©ç»ˆç‚¹...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small text-muted">ç®—æ³•é€‰æ‹©</label>
                                <select class="form-select" id="algoSelect">
                                    <option value="dijkstra" selected>Dijkstra (æ ‡å‡†åŒç›®æ ‡)</option>
                                    <option value="astar">A* Search (å¯å‘å¼æœç´¢)</option>
                                    <option value="bfs">BFS (æœ€å°‘ä¸­è½¬)</option>
                                </select>
                            </div>
                            <button class="btn btn-primary w-100" onclick="calculatePath()">
                                <i class="fas fa-search me-2"></i>å¼€å§‹è§„åˆ’
                            </button>
                        </div>
                    </div>

                    <!-- Results -->
                    <div id="routeResults" class="result-card">
                        <div class="card card-custom border-start border-4 border-danger">
                            <div class="card-body">
                                <h6 class="card-title d-flex justify-content-between">
                                    <span><i class="fas fa-clock text-danger me-2"></i>æ—¶é—´æœ€çŸ­</span>
                                    <span class="badge badge-time" id="timeVal"></span>
                                </h6>
                                <p class="card-text small text-muted mb-2" id="timePath"></p>
                                <div class="d-flex justify-content-between small">
                                    <span>ç¥¨ä»·: <span id="timeCost" class="fw-bold"></span>å…ƒ</span>
                                    <span>ç»åœ: <span id="timeStops"></span>ç«™</span>
                                </div>
                            </div>
                        </div>

                        <div class="card card-custom border-start border-4 border-success">
                            <div class="card-body">
                                <h6 class="card-title d-flex justify-content-between">
                                    <span><i class="fas fa-piggy-bank text-success me-2"></i>ç¥¨ä»·æœ€ä½</span>
                                    <span class="badge badge-cost" id="costVal"></span>
                                </h6>
                                <p class="card-text small text-muted mb-2" id="costPath"></p>
                                <div class="d-flex justify-content-between small">
                                    <span>è€—æ—¶: <span id="costTime" class="fw-bold"></span>å°æ—¶</span>
                                    <span>ç»åœ: <span id="costStops"></span>ç«™</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info small" id="recommendation">
                            <i class="fas fa-info-circle me-1"></i>
                            <span id="recText"></span>
                        </div>
                    </div>
                </div>

                <!-- Analysis Tab -->
                <div class="tab-pane fade" id="pills-analysis">
                    <div class="card card-custom">
                        <div class="card-body">
                            <h6 class="card-title mb-3">ğŸ† ç»¼åˆç½‘ç»œåˆ†æ</h6>
                            
                            <ul class="nav nav-tabs nav-fill small mb-3" id="analysisTabs" role="tablist">
                                <li class="nav-item">
                                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-betweenness" type="button">ä»‹æ•°ä¸­å¿ƒæ€§</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-degree" type="button">åº¦ä¸­å¿ƒæ€§</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-closeness" type="button">æ¥è¿‘ä¸­å¿ƒæ€§</button>
                                </li>
                            </ul>

                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="tab-betweenness">
                                    <p class="small text-muted mb-2">è¡¡é‡èŠ‚ç‚¹ä½œä¸º"æ¡¥æ¢"çš„é‡è¦æ€§</p>
                                    <div id="hubList"></div>
                                </div>
                                <div class="tab-pane fade" id="tab-degree">
                                    <p class="small text-muted mb-2">è¡¡é‡èŠ‚ç‚¹çš„ç›´æ¥è¿æ¥æ•°é‡ï¼ˆæ¢çº½ç¨‹åº¦ï¼‰</p>
                                    <div id="degreeList"></div>
                                </div>
                                <div class="tab-pane fade" id="tab-closeness">
                                    <p class="small text-muted mb-2">è¡¡é‡èŠ‚ç‚¹åˆ°å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹çš„å¹³å‡è·ç¦»</p>
                                    <div id="closenessList"></div>
                                </div>
                            </div>

                            <button class="btn btn-outline-primary w-100 mt-3 btn-sm" onclick="loadAdvancedAnalysis()">
                                <i class="fas fa-sync-alt me-1"></i>åˆ·æ–°åˆ†ææ•°æ®
                            </button>
                        </div>
                    </div>
                    
                    <div class="card card-custom mt-3">
                        <div class="card-body">
                            <h6 class="card-title">ğŸ“Š ç½‘ç»œç»Ÿè®¡</h6>
                            <ul class="list-unstyled small mb-0 mt-3">
                                <li class="mb-2 d-flex justify-content-between">
                                    <span>åŸå¸‚èŠ‚ç‚¹</span>
                                    <span class="fw-bold" id="nodeCount">-</span>
                                </li>
                                <li class="mb-2 d-flex justify-content-between">
                                    <span>é«˜é“çº¿è·¯</span>
                                    <span class="fw-bold" id="edgeCount">-</span>
                                </li>
                                <li class="mb-2 d-flex justify-content-between">
                                    <span>å¹³å‡èšç±»ç³»æ•°</span>
                                    <span class="fw-bold" id="avgClustering">-</span>
                                </li>
                                <li class="d-flex justify-content-between">
                                    <span>è¿é€šæ€§</span>
                                    <span class="text-success fw-bold">å®Œå…¨è¿é€š</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- MST Tab -->
                <div class="tab-pane fade" id="pills-mst">
                    <div class="card card-custom">
                        <div class="card-body">
                            <h6 class="card-title mb-3">ğŸŒ² æœ€å°ç”Ÿæˆæ ‘ (MST)</h6>
                            <p class="small text-muted">å±•ç¤ºå¦‚ä½•ä»¥æœ€å°æˆæœ¬è¿æ¥æ‰€æœ‰åŸå¸‚</p>
                            
                            <div class="mb-3">
                                <label class="form-label small text-muted">é€‰æ‹©ç®—æ³•</label>
                                <select class="form-select" id="mstAlgo">
                                    <option value="prim">Prim ç®—æ³• (æ™®é‡Œå§†)</option>
                                    <option value="kruskal">Kruskal ç®—æ³• (å…‹é²æ–¯å¡å°”)</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small text-muted">ä¼˜åŒ–ç›®æ ‡</label>
                                <select class="form-select" id="mstWeight">
                                    <option value="cost">æœ€ä½ç¥¨ä»· (Cost)</option>
                                    <option value="time">æœ€çŸ­æ—¶é—´ (Time)</option>
                                </select>
                            </div>
                            
                            <div class="alert alert-light small text-muted" id="mstDesc">
                                <strong>Primç®—æ³•ï¼š</strong> ä»ä¸€ä¸ªèŠ‚ç‚¹å‡ºå‘ï¼Œæ¯æ¬¡é€‰æ‹©è¿æ¥å·²è®¿é—®é›†åˆå’Œæœªè®¿é—®é›†åˆçš„æœ€å°è¾¹ã€‚é€‚åˆç¨ å¯†å›¾ã€‚
                            </div>

                            <button class="btn btn-success w-100" onclick="runMST()">
                                <i class="fas fa-play me-2"></i>å¼€å§‹ç”ŸæˆåŠ¨ç”»
                            </button>
                            
                            <div class="mt-3 small text-muted">
                                <div class="d-flex justify-content-between">
                                    <span>å½“å‰æ­¥éª¤:</span>
                                    <span id="mstStep">0 / 0</span>
                                </div>
                                <div class="progress mt-1" style="height: 5px;">
                                    <div class="progress-bar bg-success" id="mstProgress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-auto pt-4 text-center">
                <small class="text-muted" style="font-size: 0.75rem;">
                    &copy; 2025 China Railway Network System<br>
                    Graph Theory Course Design
                </small>
            </div>
        </div>

        <!-- Map Area -->
        <div class="col-md-9 position-relative">
            <div id="main-map"></div>
            
            <!-- Map Controls -->
            <div class="position-absolute top-0 end-0 m-3">
                <div class="btn-group bg-white shadow rounded">
                    <button class="btn btn-sm btn-light" onclick="resetMap()" title="é‡ç½®è§†å›¾">
                        <i class="fas fa-compress-arrows-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<!-- China Map Data -->
<script src="https://assets.pyecharts.org/assets/maps/china.js"></script>

<script>
    let myChart = null;
    let graphData = null;
    let allCities = []; // Store cities for waypoints
    let mstInterval = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        loadCities();
        loadGraphData();
        
        // MST Algo description change
        document.getElementById('mstAlgo').addEventListener('change', function(e) {
            const desc = document.getElementById('mstDesc');
            if (e.target.value === 'prim') {
                desc.innerHTML = '<strong>Primç®—æ³•ï¼š</strong> ä»ä¸€ä¸ªèŠ‚ç‚¹å‡ºå‘ï¼Œæ¯æ¬¡é€‰æ‹©è¿æ¥å·²è®¿é—®é›†åˆå’Œæœªè®¿é—®é›†åˆçš„æœ€å°è¾¹ã€‚é€‚åˆç¨ å¯†å›¾ã€‚';
            } else {
                desc.innerHTML = '<strong>Kruskalç®—æ³•ï¼š</strong> å°†æ‰€æœ‰è¾¹æŒ‰æƒé‡æ’åºï¼Œä»å°åˆ°å¤§æ·»åŠ ä¸æ„æˆç¯çš„è¾¹ã€‚é€‚åˆç¨€ç–å›¾ã€‚';
            }
        });
    });

    function initMap() {
        myChart = echarts.init(document.getElementById('main-map'));
        window.addEventListener('resize', function() {
            myChart.resize();
        });
    }

    function loadCities() {
        fetch('/api/cities')
            .then(response => response.json())
            .then(cities => {
                allCities = cities; // Save for later
                const startSelect = document.getElementById('startCity');
                const endSelect = document.getElementById('endCity');
                
                cities.forEach(city => {
                    startSelect.add(new Option(city, city));
                    endSelect.add(new Option(city, city));
                });
            });
    }
    
    function addWaypoint() {
        const container = document.getElementById('waypointsContainer');
        const id = 'waypoint-' + Date.now();
        
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.id = id;
        
        let options = '<option selected disabled>é€”å¾„åŸå¸‚...</option>';
        allCities.forEach(city => {
            options += `<option value="${city}">${city}</option>`;
        });
        
        div.innerHTML = `
            <span class="input-group-text bg-white"><i class="fas fa-map-marker-alt text-secondary"></i></span>
            <select class="form-select waypoint-select">
                ${options}
            </select>
            <button class="btn btn-outline-danger" onclick="document.getElementById('${id}').remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        container.appendChild(div);
    }

    function loadGraphData() {
        fetch('/api/graph-data')
            .then(response => response.json())
            .then(data => {
                graphData = data;
                renderMap(data);
                
                // Update stats
                document.getElementById('nodeCount').innerText = data.nodes.length;
                document.getElementById('edgeCount').innerText = data.edges.length;
                
                document.getElementById('loading').style.display = 'none';
            });
    }

    function renderMap(data, highlightPath = null) {
        const lines = [];
        const points = data.nodes;
        
        // Process edges
        data.edges.forEach(edge => {
            const sourceNode = points.find(p => p.name === edge.source);
            const targetNode = points.find(p => p.name === edge.target);
            
            if (sourceNode && targetNode) {
                lines.push({
                    coords: [sourceNode.value, targetNode.value],
                    lineStyle: {
                        color: '#ccc',
                        width: 1,
                        opacity: 0.4,
                        curveness: 0.2
                    }
                });
            }
        });

        // Highlight path if exists
        const highlightLines = [];
        
        if (highlightPath) {
            // Time path (Red)
            if (highlightPath.time_details) {
                highlightPath.time_details.forEach(segment => {
                    const source = points.find(p => p.name === segment.source);
                    const target = points.find(p => p.name === segment.target);
                    if (source && target) {
                        highlightLines.push({
                            coords: [source.value, target.value],
                            lineStyle: {
                                color: '#dc3545',
                                width: 4,
                                opacity: 1,
                                curveness: 0.2
                            },
                            label: {
                                show: true,
                                position: 'middle',
                                formatter: segment.time + 'h',
                                color: '#dc3545',
                                fontWeight: 'bold',
                                fontSize: 10
                            }
                        });
                    }
                });
            }
            
            // Cost path (Green)
            if (highlightPath.cost_details) {
                // Check if paths are different to avoid complete overlap
                const isSame = JSON.stringify(highlightPath.time_path) === JSON.stringify(highlightPath.cost_path);
                
                if (!isSame) {
                    highlightPath.cost_details.forEach(segment => {
                        const source = points.find(p => p.name === segment.source);
                        const target = points.find(p => p.name === segment.target);
                        if (source && target) {
                            highlightLines.push({
                                coords: [source.value, target.value],
                                lineStyle: {
                                    color: '#198754',
                                    width: 3,
                                    type: 'dashed',
                                    opacity: 1,
                                    curveness: 0.2
                                },
                                label: {
                                    show: true,
                                    position: 'middle',
                                    formatter: 'Â¥' + segment.cost,
                                    color: '#198754',
                                    fontWeight: 'bold',
                                    fontSize: 10,
                                    offset: [0, 15] // Offset label to avoid overlap
                                }
                            });
                        }
                    });
                }
            }
        }

        const option = {
            backgroundColor: '#e8f4fc',
            title: {
                text: 'ä¸­å›½é«˜é“ç½‘ç»œæ‹“æ‰‘å›¾',
                left: 'center',
                top: 20,
                textStyle: { color: '#333' }
            },
            tooltip: {
                trigger: 'item',
                formatter: function (params) {
                    return params.name;
                }
            },
            geo: {
                map: 'china',
                roam: true,
                zoom: 1.2,
                label: {
                    emphasis: { show: false }
                },
                itemStyle: {
                    normal: {
                        areaColor: '#fcfdfe',
                        borderColor: '#a8c6df',
                        borderWidth: 1
                    },
                    emphasis: {
                        areaColor: '#dbebfb'
                    }
                }
            },
            series: [
                // Background Lines
                {
                    type: 'lines',
                    coordinateSystem: 'geo',
                    data: lines,
                    zlevel: 1,
                    effect: {
                        show: false
                    }
                },
                // Highlight Lines
                {
                    type: 'lines',
                    coordinateSystem: 'geo',
                    data: highlightLines,
                    zlevel: 2,
                    effect: {
                        show: true,
                        period: 4,
                        trailLength: 0.5,
                        color: '#fff',
                        symbol: 'arrow',
                        symbolSize: 6
                    },
                    lineStyle: {
                        curveness: 0.2
                    }
                },
                // Cities
                {
                    type: 'scatter',
                    coordinateSystem: 'geo',
                    data: points,
                    symbolSize: 8,
                    label: {
                        normal: {
                            formatter: '{b}',
                            position: 'right',
                            show: true,
                            fontSize: 10,
                            color: '#333'
                        },
                        emphasis: { show: true }
                    },
                    itemStyle: {
                        normal: { color: '#409EFF' }
                    },
                    zlevel: 3
                }
            ]
        };

        myChart.setOption(option);
    }

    function calculatePath() {
        const start = document.getElementById('startCity').value;
        const end = document.getElementById('endCity').value;
        const algorithm = document.getElementById('algoSelect').value;
        
        // Collect waypoints
        const waypoints = [];
        document.querySelectorAll('.waypoint-select').forEach(select => {
            if (select.value && select.value !== "é€”å¾„åŸå¸‚...") {
                waypoints.push(select.value);
            }
        });
        
        if (start === "é€‰æ‹©èµ·ç‚¹..." || end === "é€‰æ‹©ç»ˆç‚¹...") {
            alert("è¯·é€‰æ‹©èµ·ç‚¹å’Œç»ˆç‚¹åŸå¸‚");
            return;
        }
        
        fetch('/api/path', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ start, end, waypoints, algorithm })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            // Show results
            document.getElementById('routeResults').style.display = 'block';
            
            // Time Path
            document.getElementById('timeVal').innerText = data.total_time.toFixed(1) + ' å°æ—¶';
            document.getElementById('timePath').innerText = data.time_path.join(' â†’ ');
            document.getElementById('timeCost').innerText = data.time_path_cost;
            document.getElementById('timeStops').innerText = data.time_path.length;
            
            // Cost Path
            if (data.cost_path) {
                document.getElementById('costVal').innerText = data.total_cost + ' å…ƒ';
                document.getElementById('costPath').innerText = data.cost_path.join(' â†’ ');
                document.getElementById('costTime').innerText = data.cost_path_time.toFixed(1);
                document.getElementById('costStops').innerText = data.cost_path.length;
            } else {
                // Handle BFS case where cost path might be same or hidden
                document.getElementById('costVal').innerText = '-';
                document.getElementById('costPath').innerText = 'åŒä¸Š (BFSæ¨¡å¼)';
                document.getElementById('costTime').innerText = '-';
                document.getElementById('costStops').innerText = '-';
            }
            
            // Recommendation
            const recText = document.getElementById('recText');
            if (waypoints.length > 0) {
                recText.innerText = `å·²ä¸ºæ‚¨è§„åˆ’é€”å¾„ ${waypoints.length} ä¸ªåŸå¸‚çš„è·¯çº¿ã€‚`;
            } else if (algorithm === 'bfs') {
                recText.innerText = "BFS ç®—æ³•å·²ä¸ºæ‚¨æ‰¾åˆ°ä¸­è½¬æ¬¡æ•°æœ€å°‘çš„è·¯å¾„ã€‚";
            } else if (JSON.stringify(data.time_path) === JSON.stringify(data.cost_path)) {
                recText.innerText = "ä¸¤æ–¹æ¡ˆè·¯çº¿ç›¸åŒï¼Œè¿™æ˜¯æœ€ä¼˜é€‰æ‹©ï¼";
            } else {
                const timeDiff = (data.cost_path_time - data.total_time).toFixed(1);
                const costDiff = data.time_path_cost - data.total_cost;
                recText.innerText = `æ–¹æ¡ˆAå¿« ${timeDiff} å°æ—¶ï¼Œä½†è´µ ${costDiff} å…ƒã€‚è¯·æŒ‰éœ€é€‰æ‹©ã€‚`;
            }
            
            // Update Map
            renderMap(graphData, data);
        });
    }

    function runMST() {
        const algorithm = document.getElementById('mstAlgo').value;
        const weight = document.getElementById('mstWeight').value;
        const btn = document.querySelector('#pills-mst button');
        
        // Reset UI
        if (mstInterval) clearInterval(mstInterval);
        btn.disabled = true;
        document.getElementById('mstProgress').style.width = '0%';
        document.getElementById('mstStep').innerText = '0 / 0';
        
        fetch('/api/mst?algorithm=' + algorithm + '&weight=' + weight)
            .then(response => response.json())
            .then(data => {
                const steps = data.steps;
                const totalSteps = steps.length;
                let currentStep = 0;
                
                // Clear previous highlights
                renderMap(graphData);
                
                const mstEdges = [];
                
                mstInterval = setInterval(() => {
                    if (currentStep >= totalSteps) {
                        clearInterval(mstInterval);
                        btn.disabled = false;
                        return;
                    }
                    
                    const step = steps[currentStep];
                    mstEdges.push(step);
                    
                    // Update Map
                    updateMSTMap(mstEdges, weight);
                    
                    // Update UI
                    currentStep++;
                    const progress = (currentStep / totalSteps) * 100;
                    document.getElementById('mstProgress').style.width = progress + '%';
                    document.getElementById('mstStep').innerText = `${currentStep} / ${totalSteps}`;
                    
                }, 800); // 800ms per step for clearer animation
            });
    }

    function updateMSTMap(edges, weightType) {
        const points = graphData.nodes;
        const highlightLines = [];
        
        edges.forEach(edge => {
            const source = points.find(p => p.name === edge.u);
            const target = points.find(p => p.name === edge.v);
            if (source && target) {
                highlightLines.push({
                    coords: [source.value, target.value],
                    lineStyle: {
                        color: '#6610f2', // Indigo for MST
                        width: 4,
                        opacity: 1,
                        curveness: 0.2
                    },
                    label: {
                        show: true,
                        formatter: weightType === 'time' ? edge.weight + 'h' : 'Â¥' + edge.weight,
                        position: 'middle',
                        fontSize: 10,
                        fontWeight: 'bold',
                        color: '#6610f2'
                    }
                });
            }
        });
        
        // Update the highlight series (index 1)
        myChart.setOption({
            series: [
                {}, // Ignore background lines
                {
                    data: highlightLines,
                    effect: {
                        show: true,
                        color: '#fff',
                        period: 4,
                        symbol: 'circle',
                        symbolSize: 4
                    },
                    lineStyle: {
                        curveness: 0.2
                    }
                }
            ]
        });
    }

    function loadAdvancedAnalysis() {
        fetch('/api/advanced-analysis')
            .then(response => response.json())
            .then(data => {
                renderRankList('hubList', data.degree); // Reusing degree for betweenness tab temporarily or fetch real betweenness
                // Wait, the API returns degree, closeness, clustering.
                // I need to fetch betweenness separately or include it in advanced analysis.
                // Let's fetch betweenness as well or just use the existing /api/hubs for the first tab.
                
                // Actually, let's just fetch /api/hubs for the first tab and /api/advanced-analysis for others.
                // But to keep it simple, I'll fetch both here.
                
                fetch('/api/hubs').then(res => res.json()).then(hubs => {
                    renderRankList('hubList', hubs);
                });

                renderRankList('degreeList', data.degree);
                renderRankList('closenessList', data.closeness);
                
                document.getElementById('avgClustering').innerText = data.avg_clustering.toFixed(4);
            });
    }

    function renderRankList(containerId, data) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        if (!data || data.length === 0) return;
        
        const maxScore = data[0].score;
        
        data.forEach((item, index) => {
            const percent = (item.score / maxScore) * 100;
            const html = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between small mb-1">
                        <span class="fw-bold">#${index + 1} ${item.name}</span>
                        <span class="text-muted">${item.score.toFixed(4)}</span>
                    </div>
                    <div class="hub-bar">
                        <div class="hub-bar-fill" style="width: ${percent}%"></div>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });
    }
    
    function resetMap() {
        myChart.dispatchAction({
            type: 'restore'
        });
    }
    
    // Load hubs initially
    loadAdvancedAnalysis();
</script>

</body>
</html>
